version: 2.1
executors:
  node-browser:
    docker:
      - image: cimg/node:20.14.0-browsers
orbs:
  browser-tools: circleci/browser-tools@1.4.7

parameters:
  backend-url:
    type: string
    default: "https://qa.instawork.com"
    description: "Endpoint to run your test against, default is qa"
  send-slack-notification:
    type: boolean
    default: false
  prompt:
    type: string
    default: 'pass'
    description: "Your prompt to QAtomator"
  target-entry-point:
    type: enum
    default: 'landingPage'
    enum: [ 'landingPage' ]
  qatomate:
    type: boolean
    default: false
    description: "Run QAtomator"
  # Extensions
  steps-limit:
    type: integer
    default: 50
    description: "Number of steps to run in QAtomator"
  prompt-part-1:
    type: string
    default: ""
    description: "Your prompt to QAtomator in parts - 1"
  prompt-part-2:
    type: string
    default: ""
    description: "Your prompt to QAtomator in parts - 2"
  prompt-part-3:
    type: string
    default: ""
    description: "Your prompt to QAtomator in parts - 3"


jobs:
  QAtomate:
    executor: node-browser
    resource_class: medium
    working_directory: ~/qatomator
    parameters:
    steps:
      - browser-tools/install-chrome
      - browser-tools/install-chromedriver
      - run:
          name: Check version of installed node, browser, drivers
          command: |
            google-chrome --version
            export PATH="/usr/local/bin/chromedriver:$PATH"
            chromedriver --version
            node -v
      - checkout
      - restore_cache:
          keys:
            - node-modules-{{ checksum "yarn.lock" }}
      - run:
          name: Install dependencies
          command: yarn
      - save_cache:
          paths:
            - node_modules
          key: node-modules-{{ checksum "yarn.lock" }}
      - run:
          name: Combine Prompt Parts and Replace Variable
          command: |
            PROMPT=""
            echo "<< pipeline.parameters.prompt-part-1 >>"
            echo "<< pipeline.parameters.prompt-part-2 >>"
            echo "<< pipeline.parameters.prompt-part-3 >>"
            echo "STARTING"
            echo $PROMPT
            if [ ! -z "<< pipeline.parameters.prompt-part-1 >>" ]; then
              PROMPT="<< pipeline.parameters.prompt-part-1 >>\n"
            fi
            echo $PROMPT
            if [ ! -z "<< pipeline.parameters.prompt-part-2 >>" ]; then
              addon="<< pipeline.parameters.prompt-part-2 >>\n"
              PROMPT="$PROMPT$addon"
            fi
            echo $PROMPT
            if [ ! -z "<< pipeline.parameters.prompt-part-3 >>" ]; then
              addon="<< pipeline.parameters.prompt-part-3 >>\n"
              PROMPT="$PROMPT$addon"
            fi
            echo "Combined Prompt: $PROMPT"
            sed -i "s/prompt\s*=\s*defaultPrompt/prompt=\`$PROMPT\`/" automator/qatomate.ts
            cat automator/qatomate.ts
      - run:
          name: Install xvfb and ffmpeg for video recording
          command: |
            sudo apt-get install -y xvfb
            sudo apt-get install -y ffmpeg
      - run:
          name: Setup Xvfb
          command: |
            # Kill any existing Xvfb process
            pkill Xvfb

            # Remove any existing lock file
            rm -f /tmp/.X99-lock

            # Start Xvfb
            Xvfb :99 -screen 0 1920x1080x24 &

            # Wait for Xvfb to start
            sleep 2

            # Set the DISPLAY environment variable
            export DISPLAY=:99

            # Print Xvfb process information
            ps aux | grep Xvfb | grep -v grep
      - run:
          name: Test video recording
          command: |
            # Create artifacts directory
            mkdir -p artifacts
            
            # Start recording with ffmpeg
            ffmpeg -f x11grab -video_size 1920x1080 -i :99 -codec:v libx264 -r 30 -t 5 artifacts/test_video.mp4

            # Check if the video file was created
            ls -l artifacts/test_video.mp4

            # Use ffprobe to check video information
            ffprobe -v error -show_entries stream=codec_type,width,height -of default=noprint_wrappers=1 artifacts/test_video.mp4
      - run:
          name: Check FFmpeg version
          command: ffmpeg -version
      - run:
          name: Running QAtomator
          command: |
            GIT_COMMIT_DESC=$(git log --format=%B -n 1 $CIRCLE_SHA1)
            echo "GIT_COMMIT_DESC=$GIT_COMMIT_DESC"
            
            sed -i "s/^STEPS_LIMIT\s*=.*/STEPS_LIMIT=<< pipeline.parameters.steps-limit >>/" extension/.env

            if [[ "$GIT_COMMIT_DESC" =~ "qatomate" ]] || [ << pipeline.parameters.qatomate >> == "true" ]
            then
              echo "Initialising extension"
              yarn start
              sleep 10
              echo "QAtomating!"
              yarn ts-node automator/qatomate.ts
            else
              echo "'qatomate' command not found in commit message. Skipping."
              exit 0
            fi
      #      - run:
      #          name: Ping results on Slack
      #          command: |
      #              if (<< parameters.send-slack-notification >>); then
      #                 node ~/repo/nightwatch/scripts/testSummaryToSlack.js ~/repo/nightwatch/reports $CIRCLE_BUILD_URL $QA_TOOLS_WEBHOOK_URL
      #              fi
      #          when: always
      #      - store_test_results:
      #          path: ~/
      - run:
          name: Zip all contents of artifacts folder
          working_directory: ~/qatomator/artifacts
          command: zip -r artifacts.zip .
      - store_artifacts:
          path: ~/qatomator/artifacts

workflows:
  QAtomate:
    # to trigger if prompt and entryPoint is provided above or other alternatives
    #    when:
    #      or:
    #        - and:
    #            - equal: [ master, << pipeline.git.branch >> ]
    #            - equal: [ api, << pipeline.trigger_source >> ]
    #        # Custom backend-url, mainly for demoservers
    #        - not:
    #            equal: [ https://qa.instawork.com, << pipeline.parameters.backend-url >> ]
    jobs:
      - QAtomate
#          send-slack-notification: false
#          context:
#            - Slack
#            - QA


